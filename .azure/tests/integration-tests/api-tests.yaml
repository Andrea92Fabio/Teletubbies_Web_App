steps:
# Test API Backend
- script: |
    set -x
    RESPONSE=$(curl -s -o temp.json -w "%{http_code}" \
      -X POST "$(BACKEND_URL_API)" \
      -H "Content-Type: application/json" \
      -d '$(TEST_DATA)')

    echo "HTTP Status: $RESPONSE"
    echo "Response body:"
    cat temp.json

    if [ "$RESPONSE" = "201" ] && grep -q "submission successful" temp.json; then
      echo "Test backend superato"
    else
      echo "Test backend fallito"
      exit 1
    fi
  displayName: 'Integration Test - Backend API'

# Test API Frontend
- script: |
    RESPONSE=$(curl -s -o temp_front.json -w "%{http_code}" \
      -X POST "$(FRONTEND_URL_API)" \
      -H "Content-Type: application/json" \
      -d '$(TEST_DATA)')

    echo "HTTP Status: $RESPONSE"
    echo "Response body:"
    cat temp_front.json

    if [ "$RESPONSE" = "201" ] && grep -q "submission successful" temp_front.json; then
      echo "Test frontend superato"
    else
      echo "Test frontend fallito"
      exit 1
    fi
  displayName: 'Integration Test - Frontend API'

# Direct Database to verify created Users
- script: |
    USER_COUNT=$(mysql -h 127.0.0.1 -P 3307 -u root -pmysecretpassword san_martino_friendship_day \
    -e "SELECT COUNT(*) FROM customers WHERE email='xhunterx92@gmail.com';" | tail -n 1)

    echo "Trovati $USER_COUNT utenti con l'email 'xhunterx92@gmail.com'."

    if [ "$USER_COUNT" = "1" ]; then
      echo "Verifica del database superata: l'utente Ã¨ stato creato una sola volta."
    else
      echo "Verifica del database fallita: trovato un numero di utenti diverso da 1."
      exit 1
    fi
  displayName: 'Verify Test User via MySQL Client'
